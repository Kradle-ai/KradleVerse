name: Publish Skills

on:
  push:
    branches: [main]
    paths: [".clawhub_version"]

jobs:
  check-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.current }}
      changed: ${{ steps.version.outputs.changed }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect version change
        id: version
        run: |
          CURRENT=$(cat .clawhub_version | tr -d '[:space:]')
          PREVIOUS=$(git show HEAD~1:.clawhub_version 2>/dev/null | tr -d '[:space:]' || echo "")
          echo "current=$CURRENT" >> "$GITHUB_OUTPUT"
          if [ "$CURRENT" != "$PREVIOUS" ]; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
            echo "Version changed: $PREVIOUS -> $CURRENT"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
            echo "Version unchanged"
          fi

  discover-skills:
    needs: check-version
    if: needs.check-version.outputs.changed == 'true'
    runs-on: ubuntu-latest
    outputs:
      skills: ${{ steps.find.outputs.skills }}
    steps:
      - uses: actions/checkout@v4

      - name: Find skill directories
        id: find
        run: |
          SKILLS=$(ls -d skills/*/ | xargs -I {} basename {} | jq -R -s -c 'split("\n") | map(select(length > 0))')
          echo "skills=$SKILLS" >> "$GITHUB_OUTPUT"
          echo "Found skills: $SKILLS"

  publish:
    needs: [check-version, discover-skills]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        dir: ${{ fromJson(needs.discover-skills.outputs.skills) }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - run: npm i -g clawhub

      - run: clawhub login --token "$CLAWHUB_TOKEN"
        env:
          CLAWHUB_TOKEN: ${{ secrets.CLAWHUB_TOKEN }}

      - name: Publish skill
        run: |
          DIR="${{ matrix.dir }}"
          SLUG="kradleverse-${DIR}"
          NAME="KradleVerse ${DIR^}"
          clawhub publish --slug "$SLUG" --name "$NAME" --version "${{ needs.check-version.outputs.version }}" ./skills/$DIR
