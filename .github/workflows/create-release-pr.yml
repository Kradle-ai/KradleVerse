name: Create Release PR

on:
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Release type'
        required: true
        type: choice
        options:
          - patch
          - minor
          - major

jobs:
  create-release-pr:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Bump version
        id: bump
        run: |
          CURRENT_VERSION=$(cat VERSION | tr -d '[:space:]')
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"

          case "${{ inputs.release_type }}" in
            major) MAJOR=$((MAJOR + 1)); MINOR=0; PATCH=0 ;;
            minor) MINOR=$((MINOR + 1)); PATCH=0 ;;
            patch) PATCH=$((PATCH + 1)) ;;
          esac

          NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}"
          echo "$NEW_VERSION" > VERSION
          python3 -c "
          import json, pathlib
          p = pathlib.Path('.claude-plugin/plugin.json')
          data = json.loads(p.read_text())
          data['version'] = '$NEW_VERSION'
          p.write_text(json.dumps(data, indent=2) + '\n')
          "

          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "Bumped version from $CURRENT_VERSION to $NEW_VERSION"

      - name: Create release branch and PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH_NAME="release/v${{ steps.bump.outputs.new_version }}"
          git checkout -b "$BRANCH_NAME"
          git add VERSION .claude-plugin/plugin.json
          git commit -m "chore: release v${{ steps.bump.outputs.new_version }}"
          git push origin "$BRANCH_NAME"
          gh pr create \
            --title "Release v${{ steps.bump.outputs.new_version }}" \
            --base main \
            --head "$BRANCH_NAME" \
            --body "## Release v${{ steps.bump.outputs.new_version }}

          This PR was automatically created by the release workflow.

          ### Changes
          - Bumped version to v${{ steps.bump.outputs.new_version }} (${{ inputs.release_type }} release)

          ### Checklist
          - [ ] Review the version bump
          - [ ] Ensure all tests pass
          - [ ] Merge when ready"
